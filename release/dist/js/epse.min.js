var Utils,ECS,EPSE,__extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(t,e){function i(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(t){var e=function(t){this.name=t};(ECS||(ECS={})).Component=e}(),function(t){var e=function(){function t(){this.items={}}return t.prototype.set=function(t,e){this.items[t]=e},t.prototype.delete=function(t){return delete this.items[t]},t.prototype.has=function(t){return t in this.items},t.prototype.get=function(t){return this.items[t]},t.prototype.len=function(){return Object.keys(this.items).length},t.prototype.forEach=function(t){for(var e in this.items)t(e,this.items[e])},t.prototype.forEach2=function(t){for(var e in this.items)return t(e,this.items[e]),this.items[e]},t}();t.HashSet=e}(Utils||(Utils={})),function(t){var e=function(){function t(t){this.count=0,this.name=t,this.id=(+new Date).toString(16)+(1e8*Math.random()|0).toString(16)+this.count,this.count++,this.components=new Utils.HashSet}return t.prototype.addComponent=function(t){return this.components.set(t.name,t),t},t.prototype.removeComponent=function(t){var e=t.name;return!!this.components.delete(e)},t}();t.Entity=e}(ECS||(ECS={})),function(t){var e=function(e){function t(){var t=e.call(this,"boundingbox")||this;return t.boundingBox={visible:!1,color:null,opacity:.2,transparent:!0,draggFlag:!1},t}return __extends(t,e),t}(ECS.Component);t.EBoundingBoxComponent=e}(EPSE||(EPSE={})),function(t){var e=function(e){function t(){var t=e.call(this,"geometry")||this;return t.getGeometry=function(t,e){t=t||this.geometry.type,e=e||{};var i=new THREE.SphereGeometry;return"Sphere"===t?i=new THREE.SphereGeometry(e.radius||this.geometry.radius,e.widthSegments||this.geometry.widthSegments,e.heightSegments||this.geometry.heightSegments,e.phiStart||this.geometry.phiStart,e.phiLength||this.geometry.phiLength,e.thetaStart||this.geometry.thetaStart,e.thetaLength||this.geometry.thetaLength):"Plane"===t?i=new THREE.PlaneGeometry(e.width||this.geometry.width,e.height||this.geometry.height,e.widthSegments||this.geometry.widthSegments,e.heightSegments||this.geometry.heightSegments):"Cube"===t?i=new THREE.CubeGeometry(e.width||this.geometry.width,e.depth||this.geometry.depth,e.height||this.geometry.height,e.widthSegments||this.geometry.widthSegments,e.heightSegments||this.geometry.heightSegments,e.depthSegments||this.geometry.depthSegments):"Circle"===t?i=new THREE.CircleGeometry(e.radius||this.geometry.radius,e.segments||this.geometry.segments,e.thetaStart||this.geometry.thetaStart,e.thetaLength||this.geometry.thetaLength):"Cylinder"===t?i=new THREE.CylinderGeometry(e.radiusTop||this.geometry.radiusTop,e.radiusBottom||this.geometry.radiusBottom,e.height||this.geometry.height,e.radialSegments||this.geometry.radialSegments,e.heightSegments||this.geometry.heightSegments,e.openEnded||this.geometry.openEnded):alert("形状オブジェクトの設定ミス"),i},t.geometry={type:null},t}return __extends(t,e),t}(ECS.Component);t.EGeometryComponent=e}(EPSE||(EPSE={})),function(t){var e=function(e){function t(){var t=e.call(this,"locus")||this;return t.locus={enabled:!1,visible:!1,color:null,maxNum:1e3},t}return __extends(t,e),t}(ECS.Component);t.ELocusComponent=e}(EPSE||(EPSE={})),function(o){o.parameter={},o.g=9.8,o.delta_t=.001,o.skipRendering=40,o.frameID="Cvs_EPSE",o.playButtonID="play",o.resetButtonID="reset",o.pictureID="picture",o.CG={},o.pauseFlag=!0,o.initFlag=!0,o.resetFlag=!1,o.makePictureFlag=!0,o.displayFPS=!0,o.draggable=!0,o.allowDrag=!0,o.locusFlag="true",o.velocityVectorFlag="pause",o.boundingBoxFlag="dragg",o.overwriteTmpStr="this",o.overwriteProperty=function t(e,i){for(var a in i)if(!(i[a]instanceof Object)||i[a]instanceof Function)e[a]=i[a];else if(i[a]instanceof Array){e[a]=[];for(var s=0;s<i[a].length;s++)e[a].push(i[a][s])}else i[a]instanceof Object?(o.overwriteTmpStr+="."+a,e[a]=e[a]||{},t(e[a],i[a])):console.log("error！");o.overwriteTmpStr="this"}}(EPSE||(EPSE={})),function(s){var t=function(e){function t(){var t=e.call(this,"material")||this;return t.material={type:"Lambert",side:"Front",color:16711680,opacity:1,transparent:!1,emissive:0,castShadow:!1,receiveShadow:!1},t}return __extends(t,e),t.prototype.getMaterial=function(t,e){t=t||this.material.type;var i={color:this.material.color,transparent:this.material.transparent,opacity:this.material.opacity,emissive:this.material.emissive,side:this.material.side};s.overwriteProperty(i,e),"Front"===i.side?i.side=THREE.FrontSide:"Double"===i.side?i.side=THREE.DoubleSide:"Back"===i.side?i.side=THREE.BackSide:alert("描画面指定ミス");var a=new THREE.MeshLambertMaterial(i);return"Lambert"===t?a=new THREE.MeshLambertMaterial(i):"Phong"===t?a=new THREE.MeshPhongMaterial(i):"Basic"===t?a=new THREE.MeshBasicMaterial(i):"Normal"===t?a=new THREE.MeshNormalMaterial(i):alert("材質オブジェクト指定ミス"),a},t}(ECS.Component);s.EMaterialComponent=t}(EPSE||(EPSE={})),function(t){var e=function(e){function t(){var t=e.call(this,"velocityvector")||this;return t.velocityVector={enabled:!1,visible:!1,color:null,scale:.5},t}return __extends(t,e),t}(ECS.Component);t.EVelocityVectorComponent=e}(EPSE||(EPSE={})),function(r){var t=function(e){function t(){var t=e.call(this,"physics")||this;return t.step=0,t.r=new THREE.Vector3,t.v=new THREE.Vector3,t.a=new THREE.Vector3,t.e=1,t.mass=1,t.r_1=new THREE.Vector3,t.r_2=new THREE.Vector3,t.recordData=!1,t.dynamic=!1,t.skipRecord=100,t.data={},t.data.x=[],t.data.y=[],t.data.z=[],t.data.vx=[],t.data.vy=[],t.data.vz=[],t.data.kinetic=[],t.data.potential=[],t.data.energy=[],t}return __extends(t,e),t.prototype.getForce=function(){return new THREE.Vector3(0,0,-this.mass*r.g)},t.prototype.getEnergy=function(){var t=this.v.lengthSq(),e=.5*this.mass*t,i=0===this.step?this.r.z:this.r_1.z;return{kinetic:e,potential:this.mass*r.g*i}},t.prototype.timeEvolution=function(){this.step++;var t=r.delta_t,e=this.getForce();this.a.x=e.x/this.mass,this.a.y=e.y/this.mass,this.a.z=e.z/this.mass,this.computeTimeEvolution(t),this.recordDynamicData()},t.prototype.computeInitialCondition=function(){var t=r.delta_t,e=this.getForce();this.a=e.clone().divideScalar(this.mass),this.r_1.x=this.r.x-this.v.x*t+.5*this.a.x*t*t,this.r_1.y=this.r.y-this.v.y*t+.5*this.a.y*t*t,this.r_1.z=this.r.z-this.v.z*t+.5*this.a.z*t*t},t.prototype.computeTimeEvolution=function(t){var e=this.r.x,i=this.r.y,a=this.r.z;this.r.x=2*this.r.x-this.r_1.x+this.a.x*t*t,this.r.y=2*this.r.y-this.r_1.y+this.a.y*t*t,this.r.z=2*this.r.z-this.r_1.z+this.a.z*t*t,this.v.x=(this.r.x-this.r_1.x)/(2*t),this.v.y=(this.r.y-this.r_1.y)/(2*t),this.v.z=(this.r.z-this.r_1.z)/(2*t),this.r_2.x=this.r_1.x,this.r_2.y=this.r_1.y,this.r_2.z=this.r_1.z,this.r_1.x=e,this.r_1.y=i,this.r_1.z=a},t.prototype.initDynamicData=function(){this.data.x=[],this.data.y=[],this.data.z=[],this.data.vx=[],this.data.vy=[],this.data.vz=[],this.data.kinetic=[],this.data.potential=[],this.data.energy=[]},t.prototype.recordDynamicData=function(){if(this.recordData&&(0==this.step||this.step/this.skipRecord>this.data.x.length)){var t=void 0,e=void 0,i=void 0,a=void 0;a=0!=this.step&&this.dynamic?(t=this.step-1,e=this.r_1.x,i=this.r_1.y,this.r_1.z):(t=this.step,e=this.r.x,i=this.r.y,this.r.z);var s=t*r.delta_t;this.data.x.push([s,e]),this.data.y.push([s,i]),this.data.z.push([s,a]),this.data.vx.push([s,this.v.x]),this.data.vy.push([s,this.v.y]),this.data.vz.push([s,this.v.z]);var o=this.getEnergy();this.data.kinetic.push([s,o.kinetic]),this.data.potential.push([s,o.potential]),this.data.energy.push([s,o.kinetic+o.potential])}},t}(ECS.Component);r.EPhysComponent=t}(EPSE||(EPSE={})),function(n){var t=function(e){function t(){var t=e.call(this,"physics_object")||this;return t.draggable=!1,t.c_physics=t.addComponent(new n.EPhysComponent),t.c_boundingBox=t.addComponent(new n.EBoundingBoxComponent),t.c_geometry=t.addComponent(new n.EGeometryComponent),t.c_locus=t.addComponent(new n.ELocusComponent),t.c_material=t.addComponent(new n.EMaterialComponent),t.c_velocityVector=t.addComponent(new n.EVelocityVectorComponent),t.visible=!0,t.allowDrag=!1,t.CG={},t}return __extends(t,e),t.prototype.create3DCG=function(){var t=this.c_geometry.getGeometry(),e=this.c_material.getMaterial(),i=this.c_boundingBox.boundingBox;this.CG=new THREE.Mesh(t,e),(this.CG.obj=this).draggable&&(this.CG.geometry.computeBoundingBox(),i.width=(new THREE.Vector3).subVectors(this.CG.geometry.boundingBox.max,this.CG.geometry.boundingBox.min),t=new THREE.CubeGeometry(i.width.x,i.width.y,i.width.z),i.color=e.color,e=new THREE.MeshBasicMaterial({color:i.color,transparent:i.transparent,opacity:i.opacity}),i.CG=new THREE.Mesh(t,e),i.center=(new THREE.Vector3).addVectors(this.CG.geometry.boundingBox.max,this.CG.geometry.boundingBox.min).divideScalar(2),i.CG.position.copy(this.c_physics.r).add(i.center),i.CG.visible=i.visible,n.CG.scene.add(i.CG))},t.prototype.create=function(){this.create3DCG();var t=this.c_material.material,e=this.c_velocityVector.velocityVector,i=this.c_locus.locus;if(this.CG.castShadow=t.castShadow,this.CG.receiveShadow=t.receiveShadow,n.CG.scene.add(this.CG),e.enabled&&(e.CG=new THREE.ArrowHelper(this.c_physics.v.clone().normalize(),this.c_physics.r.clone(),1,e.color),n.CG.scene.add(e.CG)),i.enabled){var a=new THREE.BufferGeometry,s=new Float32Array(3*i.maxNum),o=new THREE.BufferAttribute(s,3);o.dynamic=!0,a.addAttribute("position",o);var r=new THREE.LineBasicMaterial({color:i.color});i.CG=new THREE.Line(a,r),n.CG.scene.add(i.CG)}this.c_physics.recordDynamicData(),this.c_physics.computeInitialCondition()},t.prototype.update=function(){this.CG.position.copy(this.c_physics.r),this.CG.visible=this.visible;for(var t=0;t<this.CG.children.length;t++)this.CG.children[t].visible=this.visible;this.updateLocus(),this.updateVelocityVector(),this.updateBoundingBox()},t.prototype.updateLocus=function(t){var e=this.c_locus.locus;if(e.enabled){t=void 0!==t?t:e.color;for(var i=this.c_physics.data.x.length-1,a=e.CG.geometry.attributes.position.array.length/3,s=i;s<a;s++)e.CG.geometry.attributes.position.array[3*s]=this.c_physics.r.x,e.CG.geometry.attributes.position.array[3*s+1]=this.c_physics.r.y,e.CG.geometry.attributes.position.array[3*s+2]=this.c_physics.r.z;e.CG.geometry.attributes.position.needsUpdate=!0,e.CG.material.color.setHex(t);var o=!1;"true"==n.locusFlag?o=!0:"false"==n.locusFlag?o=!1:"pause"==n.locusFlag&&(o=!!n.pauseFlag),e.CG.visible=o&&e.visible}},t.prototype.updateVelocityVector=function(t,e){var i=this.c_velocityVector.velocityVector;if(i.enabled){t=void 0!==t?t:i.color,e=void 0!==e?e:i.scale;var a=this.c_physics.v.length()*e;a<.01&&(e=a=.01),i.CG.setDirection(this.c_physics.v.clone().normalize()),i.CG.setLength(a,e,e),i.CG.position.copy(this.c_physics.r),i.CG.setColor(t);var s=!1;"true"==n.velocityVectorFlag?s=!0:"false"==n.velocityVectorFlag?s=!1:"pause"==n.velocityVectorFlag&&(s=!!n.pauseFlag);for(var o=0;o<i.CG.children.length;o++)i.CG.children[o].visible=s&&i.visible}},t.prototype.updateBoundingBox=function(){if(this.draggable){var t=this.c_boundingBox.boundingBox;t.CG.position.copy(this.c_physics.r).add(t.center);var e=!1;"true"==n.boundingBoxFlag?e=!0:"false"==n.boundingBoxFlag?e=!1:"dragg"==n.boundingBoxFlag&&(e=!!t.draggFlag),t.CG.visible=e&&t.visible,this.c_physics.dynamic||(this.c_physics.v=(new THREE.Vector3).subVectors(this.c_physics.r,this.c_physics.r_1).divideScalar(n.delta_t*n.skipRendering),this.c_physics.r_1.copy(this.c_physics.r))}},t.prototype.resetParameter=function(){var t=this.c_physics;t.initDynamicData(),n.overwriteProperty(this,this.param),t.recordDynamicData(),t.computeInitialCondition()},t}(ECS.Entity);n.EPhysEntity=t}(EPSE||(EPSE={})),function(t){var e=function(e){function t(){var t=e.call(this)||this;return t.name="floor",t.n=20,t.width=1,t.colors=[10066329,3355443],t.collisionFloor=!1,t.collisionFloorVisible=!1,t.collision=!1,t}return __extends(t,e),t.prototype.create3DCG=function(){this.CG=new THREE.Object3D;for(var t=-this.n/2;t<this.n/2;t++)for(var e=-this.n/2;e<this.n/2;e++){var i=(e+.5)*this.width,a=(t+.5)*this.width,s=new THREE.PlaneGeometry(this.width,this.width),o={color:this.colors[Math.abs(t+e)%this.colors.length]},r=this.c_material.getMaterial(this.c_material.material.type,o),n=new THREE.Mesh(s,r);n.position.set(i,a,0),n.receiveShadow=this.c_material.material.receiveShadow,this.CG.add(n)}},t}(t.EPhysEntity);t.EPhysFloor=e}(EPSE||(EPSE={})),function(s){var t=function(a){function t(t){var e=a.call(this)||this;e.param=t,e.name="sphere",e.radius=1,e.draggable=!0,s.overwriteProperty(e,e.param);var i=e.c_geometry.geometry;return e.c_material.material.shading="Smooth",i.type="Sphere",i.radius=e.radius,i.widthSegments=20,i.heightSegments=20,i.phiStart=0,i.phiLength=2*Math.PI,i.thetaStart=0,i.thetaLength=Math.PI,e}return __extends(t,a),t}(s.EPhysEntity);s.EPhysSphere=t}(EPSE||(EPSE={})),function(t){var e=function(){function t(t){this.name=t}return t.prototype.Execute=function(){console.log("["+this.name+"]System Execute!")},t}();t.System=e}(ECS||(ECS={})),function(u){var t=function(e){function t(){var t=e.call(this,"three_system")||this;return t.draggableObjects=[],t.renderer={clearColor:14810367,clearAlpha:1,parameters:{antialias:!0,stencil:!0}},t.camera={type:"Perspective",position:{x:20,y:0,z:10},up:{x:0,y:0,z:1},target:{x:0,y:0,z:2},fov:45,near:.1,far:500,left:-10,right:10,top:10,bottom:-10},t.light={type:"Directional",position:{x:0,y:0,z:15},target:{x:0,y:0,z:0},color:16777215,intensity:1,distance:0,angle:Math.PI/4,exponent:20,ambient:null},t.shadow={shadowMapEnabled:!1,shadowMapWidth:512,shadowMapHeight:512,shadowCameraVisible:!1,shadowCameraNear:.1,shadowCameraFar:50,shadowCameraFov:120,shadowCameraRight:10,shadowCameraLeft:-10,shadowCameraTop:10,shadowCameraBottom:-10,shadowDarkness:.5},t.trackball={enabled:!0,noRotate:!1,rotateSpeed:2,noZoom:!1,zoomSpeed:1,noPan:!1,panSpeed:1,staticMoving:!0,dynamicDampingFactor:.3},t}return __extends(t,e),t.prototype.initThree=function(){u.CG.canvasFrame=document.getElementById(u.frameID),u.CG.renderer=new THREE.WebGLRenderer(this.renderer.parameters),u.CG.renderer||alert("Three.js Error"),u.CG.renderer.setSize(u.CG.canvasFrame.clientWidth,u.CG.canvasFrame.clientHeight),u.CG.canvasFrame.appendChild(u.CG.renderer.domElement),u.CG.renderer.setClearColor(this.renderer.clearColor,this.renderer.clearAlpha),u.CG.renderer.shadowMap.enabled=this.shadow.shadowMapEnabled,u.CG.scene=new THREE.Scene},t.prototype.initCamera=function(){"Perspective"==this.camera.type?u.CG.camera=new THREE.PerspectiveCamera(this.camera.fov,u.CG.canvasFrame.clientWidth/u.CG.canvasFrame.clientHeight,this.camera.near,this.camera.far):"Orthographic"==this.camera.type?u.CG.camera=new THREE.OrthographicCamera(this.camera.left,this.camera.right,this.camera.top,this.camera.bottom,this.camera.near,this.camera.far):alert("カメラの設定ミス"),u.CG.camera.position.set(this.camera.position.x,this.camera.position.y,this.camera.position.z),u.CG.camera.up.set(this.camera.up.x,this.camera.up.y,this.camera.up.z),u.CG.camera.lookAt({x:this.camera.target.x,y:this.camera.target.y,z:this.camera.target.z}),u.CG.trackball=new THREE.TrackballControls(u.CG.camera,u.CG.canvasFrame),u.CG.trackball.screen.width=u.CG.canvasFrame.clientWidth,u.CG.trackball.screen.height=u.CG.canvasFrame.clientHeight,u.CG.trackball.screen.offsetLeft=u.CG.canvasFrame.getBoundingClientRect().left,u.CG.trackball.screen.offsetTop=u.CG.canvasFrame.getBoundingClientRect().top,u.CG.trackball.noRotate=this.trackball.noRotate,u.CG.trackball.rotateSpeed=this.trackball.rotateSpeed,u.CG.trackball.noZoom=this.trackball.noZoom,u.CG.trackball.zoomSpeed=this.trackball.zoomSpeed,u.CG.trackball.noPan=this.trackball.noPan,u.CG.trackball.panSpeed=this.trackball.panSpeed,u.CG.trackball.target=new THREE.Vector3(this.camera.target.x,this.camera.target.y,this.camera.target.z),u.CG.trackball.staticMoving=this.trackball.staticMoving,u.CG.trackball.dynamicDampingFactor=this.trackball.dynamicDampingFactor,u.CG.trackball.enabled=this.trackball.enabled},t.prototype.initLight=function(){function t(t,e){t.castShadow=e.shadowMapEnabled,t.shadowMapWidth=e.shadowMapWidth,t.shadowMapHeight=e.shadowMapHeight,t.shadowDarkness=e.shadowDarkness,t.shadowCameraVisible=e.shadowCameraVisible,t instanceof THREE.DirectionalLight?(t.shadowCameraNear=e.shadowCameraNear,t.shadowCameraFar=e.shadowCameraFar,t.shadowCameraRight=e.shadowCameraRight,t.shadowCameraLeft=e.shadowCameraLeft,t.shadowCameraTop=e.shadowCameraTop,t.shadowCameraBottom=e.shadowCameraBottom):t instanceof THREE.SpotLight?(t.shadowCameraNear=e.shadowCameraNear,t.shadowCameraFar=e.shadowCameraFar,t.shadowCameraFov=e.shadowCameraFov):alert("シャドーカメラの設定ミス")}"Directional"==this.light.type?(u.CG.light=new THREE.DirectionalLight(this.light.color,this.light.intensity),this.shadow.shadowMapEnabled&&t(u.CG.light,this.shadow)):"Spot"==this.light.type?(u.CG.light=new THREE.SpotLight(this.light.color,this.light.intensity,this.light.distance,this.light.angle,this.light.exponent),this.shadow.shadowMapEnabled&&t(u.CG.light,this.shadow)):"Point"==this.light.type?(u.CG.light=new THREE.PointLight(this.light.color,this.light.intensity,this.light.distance),this.shadow.shadowMapEnabled&&(u.CG.light.shadowCamera=new THREE.SpotLight,u.CG.light.shadowCamera.position.set(this.light.position.x,this.light.position.y,this.light.position.z),u.CG.light.shadowCamera.onlyShadow=!0,u.CG.scene.add(u.CG.light.shadowCamera),t(u.CG.light.shadowCamera,this.shadow))):alert("光源の設定ミス"),u.CG.light.position.set(this.light.position.x,this.light.position.y,this.light.position.z),u.CG.light.target=new THREE.Object3D,u.CG.light.target.position.set(this.light.target.x,this.light.target.y,this.light.target.z),u.CG.scene.add(u.CG.light),this.light.ambient&&(u.CG.ambientLight=new THREE.AmbientLight(this.light.ambient),u.CG.scene.add(u.CG.ambientLight))},t.prototype.initDragg=function(){var h=this;if(u.draggable){var c=0,l=0,d=new THREE.Vector3,p=null,m=null,t=new THREE.PlaneGeometry(200,200,8,8),e=new THREE.MeshBasicMaterial({color:0,wireframe:!0}),g=new THREE.Mesh(t,e);g.material.visible=!1,u.CG.scene.add(g),u.CG.canvasFrame.addEventListener("mousemove",function(t){for(var e=0;e<h.draggableObjects.length;e++)h.draggableObjects[e].obj.c_boundingBox.boundingBox.draggFlag=!1;if(u.allowDrag){c=u.CG.canvasFrame.getBoundingClientRect().left,l=u.CG.canvasFrame.getBoundingClientRect().top;var i=(t.clientX-c)/u.CG.canvasFrame.clientWidth*2-1,a=-(t.clientY-l)/u.CG.canvasFrame.clientHeight*2+1,s=new THREE.Vector3(i,a,.5);s.unproject(u.CG.camera),s=s.sub(u.CG.camera.position).normalize();var o=new THREE.Raycaster(u.CG.camera.position,s);if(m){var r,n=(r=o.intersectObject(g))[0].point;return m.obj.c_boundingBox.boundingBox.CG.position.copy(n.sub(d)),m.obj.c_physics.r.copy(m.obj.c_boundingBox.boundingBox.CG.position).sub(m.obj.c_boundingBox.boundingBox.center),m.obj.c_boundingBox.boundingBox.draggFlag=!0,void h.mouseDraggEvent(m.obj)}if(0<(r=o.intersectObjects(h.draggableObjects)).length){if(p!=r[0].object){if(!r[0].object.obj.allowDrag)return;p=r[0].object,g.position.copy(p.position),g.lookAt(u.CG.camera.position)}p.obj.c_boundingBox.boundingBox.draggFlag=!0,u.CG.canvasFrame.style.cursor="pointer"}else p=null,u.CG.canvasFrame.style.cursor="auto"}},!1),u.CG.canvasFrame.addEventListener("mousedown",function(t){if(u.allowDrag){var e=(t.clientX-c)/u.CG.canvasFrame.clientWidth*2-1,i=-(t.clientY-l)/u.CG.canvasFrame.clientHeight*2+1,a=new THREE.Vector3(e,i,.5);a.unproject(u.CG.camera),a=a.sub(u.CG.camera.position).normalize();var s=new THREE.Raycaster(u.CG.camera.position,a);if(0<(o=s.intersectObjects(h.draggableObjects)).length){if(!o[0].object.obj.allowDrag)return;u.CG.trackball.enabled=!1,m=o[0].object,h.mouseDownEvent(m.obj);var o,r=(o=s.intersectObject(g))[0].point;d.copy(r).sub(g.position),u.CG.canvasFrame.style.cursor="move"}}},!1),u.CG.canvasFrame.addEventListener("mouseup",function(t){u.CG.trackball.enabled=h.trackball.enabled,u.CG.canvasFrame.style.cursor="auto",u.allowDrag&&p&&m&&(g.position.copy(p.position),m.obj.param.c_physics.r=m.obj.c_physics.r,m.obj.c_physics.dynamic&&m.obj.resetParameter(),h.mouseUpEvent(m.obj),u.makePictureFlag=!0,m=null)},!1)}},t.prototype.mouseDownEvent=function(t){},t.prototype.mouseDraggEvent=function(t){},t.prototype.mouseUpEvent=function(t){},t.prototype.Execute=function(){e.prototype.Execute.call(this),this.initThree(),this.initCamera(),this.initLight(),this.initDragg()},t}(ECS.System);u.E3DSystem=t}(EPSE||(EPSE={})),function(i){var t=function(e){function t(){return e.call(this,"event_listener")||this}return __extends(t,e),t.prototype.Execute=function(){var t=this;e.prototype.Execute.call(this),i.displayFPS&&(this.stats=new Stats,document.getElementById(i.frameID).appendChild(this.stats.domElement)),i.playButtonID?(document.getElementById(i.playButtonID).innerHTML="start",document.getElementById(i.playButtonID).addEventListener("mousedown",function(){i.initFlag=!1,i.pauseFlag=!i.pauseFlag,t.switchButton()},!1)):(i.initFlag=!1,i.pauseFlag=!1),i.resetButtonID&&(document.getElementById(i.resetButtonID).innerHTML="initial condition",document.getElementById(i.resetButtonID).addEventListener("mousedown",function(){i.resetFlag=!0,i.pauseFlag=!0,t.switchButton()},!1)),i.pictureID&&(document.getElementById(i.pictureID).innerHTML="capture")},t.prototype.switchButton=function(){if(i.pauseFlag){var t=i.resetFlag?"start":"restart";document.getElementById(i.playButtonID).innerHTML=t,document.getElementById(i.pictureID).style.visibility="visible"}else{t="pause";document.getElementById(i.playButtonID).innerHTML=t,document.getElementById(i.pictureID).style.visibility="hidden"}i.makePictureFlag=!0},t}(ECS.System);i.EEventListenerSystem=t}(EPSE||(EPSE={})),function(a){var t=function(e){function t(){var t=e.call(this,"system_core")||this;return t.step=0,t.objects=[],t.three_system=new a.E3DSystem,t.event_listener_system=new a.EEventListenerSystem,t}return __extends(t,e),t.prototype.Execute=function(){e.prototype.Execute.call(this),this.event_listener_system.Execute(),this.three_system.Execute();for(var t=0;t<this.objects.length;t++)this.createPhysObject(this.objects[t]);this.loop()},t.prototype.createPhysObject=function(t){t.create(),t.draggable&&this.three_system.draggableObjects.push(t.CG)},t.prototype.checkFlags=function(){if(a.resetFlag){for(var t=0;t<this.objects.length;t++)0!=this.objects[t].c_physics.data.x.length&&(this.objects[t].c_physics.r.x=this.objects[t].c_physics.data.x[0][1],this.objects[t].c_physics.r.y=this.objects[t].c_physics.data.y[0][1],this.objects[t].c_physics.r.z=this.objects[t].c_physics.data.z[0][1],this.objects[t].c_physics.v.x=this.objects[t].c_physics.data.vx[0][1],this.objects[t].c_physics.v.y=this.objects[t].c_physics.data.vy[0][1],this.objects[t].c_physics.v.z=this.objects[t].c_physics.data.vz[0][1],this.objects[t].allowDrag=this.objects[t].draggable,this.objects[t].c_physics.step=0,this.objects[t].resetParameter());a.resetFlag=!1,a.pauseFlag=!0,a.makePictureFlag=!0,a.initFlag=!0,this.step=0,a.allowDrag=a.draggable}},t.prototype.timeEvolution=function(){if(!a.pauseFlag)for(var t=0;t<a.skipRendering;t++){this.step++;for(var e=0;e<this.objects.length;e++)if(this.objects[e].c_physics.dynamic){this.objects[e].allowDrag=!1;for(var i=this.objects[e].c_physics.step;i<=this.step;i++)this.objects[e].c_physics.timeEvolution()}}},t.prototype.makePicture=function(){if(a.makePictureFlag){if(a.pictureID){document.getElementById(a.pictureID).href=a.CG.renderer.domElement.toDataURL("image/png");var t=a.delta_t*this.step;document.getElementById(a.pictureID).download=t.toFixed(2)+".png"}a.makePictureFlag=!1}},t.prototype.loop=function(){a.CG.trackball.update(),this.event_listener_system.stats&&this.event_listener_system.stats.update(),this.checkFlags(),this.timeEvolution();for(var t=0;t<this.objects.length;t++)this.objects[t].update();a.CG.renderer.render(a.CG.scene,a.CG.camera),this.makePicture(),requestAnimationFrame(this.loop.bind(this))},t}(ECS.System);a.EPhysCore=t}(EPSE||(EPSE={}));var floor=new EPSE.EPhysFloor,sphere=new EPSE.EPhysSphere({allowDrag:!0,c_locus:{locus:{enabled:!0,visible:!0,color:16711935,maxNum:1e3}},c_velocityVector:{velocityVector:{enabled:!0,visible:!0,color:new THREE.Color(16711935),scale:.5}},c_boundingBox:{boundingBox:{visible:!0}},c_physics:{r:new THREE.Vector3(0,0,2),v:new THREE.Vector3(0,-5,12),dynamic:!0,recordData:!0,skipRecord:50}}),phys_system=new EPSE.EPhysCore;phys_system.objects.push(floor),phys_system.objects.push(sphere),phys_system.Execute();